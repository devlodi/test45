<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Análise Lotofácil</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fff5e6;
      color: #333;
    }

    header {
      background-color: #6a1b9a;
      color: white;
      padding: 20px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .intro {
      font-size: 16px;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .input-group {
      margin-bottom: 15px;
      text-align: center;
    }

    .input-group label {
      font-weight: bold;
      margin-right: 10px;
    }

    .input-group input {
      width: 60px;
      padding: 5px;
      font-size: 16px;
      text-align: center;
    }

    .buttons {
      text-align: center;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 0 10px;
      background-color: #6a1b9a;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #8e24aa;
    }

    button:disabled {
      background-color: #ddd;
      cursor: not-allowed;
    }

    #resultados {
      margin-top: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }

    th {
      background-color: #6a1b9a;
      color: white;
    }

    .dezena {
      display: inline-block;
      width: 40px;
      height: 40px;
      line-height: 40px;
      margin: 3px;
      border-radius: 50%;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      background-color: #e0e0e0;
      border: 2px solid #6a1b9a;
      color: #6a1b9a;
    }

    .dezena.highlight {
      background-color: #ffeb3b !important;
      color: #333 !important;
      border-color: #333 !important;
    }

    .result-header {
      background-color: #f3e5f5;
      font-weight: bold;
      padding: 5px;
      border-radius: 4px;
    }

    .score {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
    }

    footer {
      background-color: #6a1b9a;
      color: white;
      text-align: center;
      padding: 10px 0;
      position: relative;
      bottom: 0;
      width: 100%;
    }

    /* Adicionado para evitar estouro lateral */
    #resultados table {
      display: block; /* Torna a tabela rolável */
      overflow-x: auto;
      white-space: nowrap; /* Impede quebra de linha nas células */
      max-width: 100%; /* Limita a largura ao container */
    }

    /* Ajuste no título da tabela para manter alinhado */
    #resultados h2 {
      text-align: left;
    }

    /* Colocar as células menores para melhorar a responsividade */
    th, td {
      font-size: 12px; /* Fonte menor para evitar vazamentos */
    }

    th {
      padding: 5px; /* Reduzindo padding para ajustar largura */
    }

    td {
      padding: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Análise Lotofácil</h1>
  </header>

  <div class="container">
    <div class="intro">
      <p>
        Bem-vindo ao sistema de análise de resultados da Lotofácil! Este sistema permite que você analise os últimos concursos da Lotofácil,
        identifique as dezenas mais frequentes e verifique como essas dezenas se comportaram nos resultados anteriores.
      </p>
      <p>
        Para começar, informe o número de concursos que deseja analisar, a quantidade de dezenas mais frequentes que deseja destacar e o número de acertos desejado.
        Clique em "Analisar" para ver os resultados detalhados.
      </p>
    </div>

    <div class="input-group">
      <label for="numConcursos">Número de concursos a analisar (x):</label>
      <input type="number" id="numConcursos" min="1" max="3255" value="10">
    </div>

    <div class="input-group">
      <label for="numDezenas">Número de dezenas mais frequentes (y):</label>
      <input type="number" id="numDezenas" min="1" max="25" value="20">
    </div>

    <!-- Novo input para o número de acertos desejado -->
    <div class="input-group">
      <label for="numAcertosDesejado">Número de acertos desejado:</label>
      <input type="number" id="numAcertosDesejado" min="1" max="15" value="14">
    </div>

    <div class="buttons">
      <button id="analisarBtn">Analisar</button>
      <button id="aprimorarBtn" disabled>Aprimorar</button>
    </div>

    <div id="resultados"></div>
  </div>

  <footer>
    <p>© 2024 Sistema de Análise Lotofácil - Todos os direitos reservados.</p>
  </footer>

  <script>
    const analisarBtn = document.getElementById('analisarBtn');
    const aprimorarBtn = document.getElementById('aprimorarBtn');
    const resultadosDiv = document.getElementById('resultados');

    let x, y, acertosDesejado;
    let concursos = [];
    let ocorrencias = {};
    let topDezenas = [];
    let combinacoes = {};

    analisarBtn.addEventListener('click', async () => {
      x = parseInt(document.getElementById('numConcursos').value);
      y = parseInt(document.getElementById('numDezenas').value);
      acertosDesejado = parseInt(document.getElementById('numAcertosDesejado').value);

      if (isNaN(x) || isNaN(y) || isNaN(acertosDesejado) || x <= 0 || y <= 0 || y > 25 || acertosDesejado <= 0 || acertosDesejado > 15) {
        alert('Por favor, insira valores válidos.');
        return;
      }

      resultadosDiv.innerHTML = '<p>Analisando resultados...</p>';
      aprimorarBtn.disabled = true;

      try {
        // Obter o número do último concurso
        const ultimoConcursoResp = await fetch('https://servicebus2.caixa.gov.br/portaldeloterias/api/lotofacil/');
        const ultimoConcursoData = await ultimoConcursoResp.json();
        let ultimoConcursoNumero = ultimoConcursoData.numero;

        // Obter resultados dos últimos x concursos
        concursos = [];
        let concursosPromises = [];
        for (let i = 0; i < x; i++) {
          let concursoNumero = ultimoConcursoNumero - i;
          concursosPromises.push(fetchConcurso(concursoNumero));
        }
        concursos = await Promise.all(concursosPromises);
        concursos = concursos.filter(concurso => concurso !== null);

        // Contar ocorrências de cada dezena
        ocorrencias = contarOcorrencias(concursos);

        // Selecionar as y dezenas mais frequentes
        topDezenas = selecionarTopDezenas(ocorrencias, y);

        // Analisar combinações das y dezenas nos resultados
        combinacoes = analisarCombinacoes(concursos, topDezenas);

        // Exibir resultados
        exibirResultados(ocorrencias, topDezenas, combinacoes, concursos);

        aprimorarBtn.disabled = false;
      } catch (error) {
        console.error(error);
        resultadosDiv.innerHTML = '<p>Ocorreu um erro ao analisar os resultados.</p>';
      }
    });

    aprimorarBtn.addEventListener('click', () => {
      aprimorarDezenas();
    });

    async function fetchConcurso(numero) {
      try {
        const response = await fetch(`https://servicebus2.caixa.gov.br/portaldeloterias/api/lotofacil/${numero}`);
        const data = await response.json();
        return data;
      } catch (error) {
        console.error(`Erro ao obter concurso ${numero}:`, error);
        return null;
      }
    }

    function contarOcorrencias(concursos) {
      let ocorrencias = {};
      for (let i = 1; i <= 25; i++) {
        ocorrencias[i] = 0;
      }

      concursos.forEach(concurso => {
        concurso.listaDezenas.forEach(dezena => {
          let num = parseInt(dezena);
          ocorrencias[num]++;
        });
      });

      return ocorrencias;
    }

    function selecionarTopDezenas(ocorrencias, y) {
      let dezenasOrdenadas = Object.entries(ocorrencias)
        .sort((a, b) => b[1] - a[1])
        .slice(0, y)
        .map(entry => parseInt(entry[0]));

      return dezenasOrdenadas;
    }

    function analisarCombinacoes(concursos, topDezenas) {
      let combinacoes = {};

      concursos.forEach(concurso => {
        let dezenasConcurso = concurso.listaDezenas.map(Number);
        let count = dezenasConcurso.filter(dezena => topDezenas.includes(dezena)).length;

        let key = `${count} acertos`;
        if (!combinacoes[key]) {
          combinacoes[key] = 0;
        }
        combinacoes[key]++;
      });

      return combinacoes;
    }

    function formatarDezena(num) {
      return num.toString().padStart(2, '0');
    }

    function exibirResultados(ocorrencias, topDezenas, combinacoes, concursos) {
      resultadosDiv.innerHTML = '';

      // Exibir ocorrências
      let ocorrenciasTable = '<h2>Ocorrências das Dezenas</h2><table><tr>';
      for (let i = 1; i <= 25; i++) {
        ocorrenciasTable += `<th>${formatarDezena(i)}</th>`;
      }
      ocorrenciasTable += '</tr><tr>';
      for (let i = 1; i <= 25; i++) {
        ocorrenciasTable += `<td>${ocorrencias[i]}</td>`;
      }
      ocorrenciasTable += '</tr></table>';
      resultadosDiv.innerHTML += ocorrenciasTable;

      // Exibir top y dezenas
      resultadosDiv.innerHTML += `<h2>Top ${topDezenas.length} Dezenas Selecionadas</h2>`;
      resultadosDiv.innerHTML += `<p>${topDezenas.sort((a, b) => a - b).map(formatarDezena).join(' ')}</p>`;

      // Exibir combinações
      let combinacoesTable = '<h2>Análise de Combinações</h2><table><tr><th>Quantidade de Acertos</th><th>Frequência</th></tr>';
      let combinacoesOrdenadas = Object.keys(combinacoes).sort((a, b) => {
        let numA = parseInt(a.split(' ')[0]);
        let numB = parseInt(b.split(' ')[0]);
        return numB - numA;
      });
      combinacoesOrdenadas.forEach(key => {
        combinacoesTable += `<tr><td>${key}</td><td>${combinacoes[key]}</td></tr>`;
      });
      combinacoesTable += '</table>';
      resultadosDiv.innerHTML += combinacoesTable;

      // Exibir resultados detalhados
      resultadosDiv.innerHTML += `<h2>Detalhes dos Últimos ${concursos.length} Concursos</h2>`;
      concursos.forEach(concurso => {
        let dezenasConcurso = concurso.listaDezenas.map(Number);
        let acertos = dezenasConcurso.filter(dezena => topDezenas.includes(dezena)).length;

        let resultHtml = `
          <div class="concurso">
            <div class="result-header">Concurso ${concurso.numero} - ${concurso.dataApuracao} - ${acertos} acertos das dezenas selecionadas</div>
            <div class="dezenas">
        `;

        dezenasConcurso.sort((a, b) => a - b).forEach(dezena => {
          let dezenaFormatada = formatarDezena(dezena);
          if (topDezenas.includes(dezena)) {
            resultHtml += `<span class="dezena highlight">${dezenaFormatada}</span>`;
          } else {
            resultHtml += `<span class="dezena">${dezenaFormatada}</span>`;
          }
        });

        resultHtml += `</div></div>`;

        resultadosDiv.innerHTML += resultHtml;
      });
    }

    function aprimorarDezenas() {
      let melhorTroca = null;
      let melhorCombinacoes = null;
      let maxDesempenho = -Infinity;

      let todasDezenas = Array.from({ length: 25 }, (_, i) => i + 1);
      let dezenasFora = todasDezenas.filter(dezena => !topDezenas.includes(dezena));

      // Percorrer todas as possíveis trocas de uma dezena dentro por uma fora
      for (let dentro of topDezenas) {
        for (let fora of dezenasFora) {
          let novoTopDezenas = topDezenas.filter(d => d !== dentro);
          novoTopDezenas.push(fora);

          // Garantir que o novo conjunto tem o tamanho correto e sem duplicatas
          novoTopDezenas = [...new Set(novoTopDezenas)];

          // Recalcular as combinações com o novo conjunto
          let novasCombinacoes = analisarCombinacoes(concursos, novoTopDezenas);

          // Avaliar o desempenho do novo conjunto
          let desempenho = calcularDesempenho(novasCombinacoes, acertosDesejado);

          if (desempenho > maxDesempenho) {
            maxDesempenho = desempenho;
            melhorTroca = { dentro, fora };
            melhorCombinacoes = novasCombinacoes;
          }
        }
      }

      if (melhorTroca && maxDesempenho > calcularDesempenho(combinacoes, acertosDesejado)) {
        // Aplicar a melhor troca encontrada
        topDezenas = topDezenas.filter(d => d !== melhorTroca.dentro);
        topDezenas.push(melhorTroca.fora);

        // Garantir que topDezenas é um array de números únicos
        topDezenas = [...new Set(topDezenas.map(Number))];

        // Atualizar as combinações
        combinacoes = melhorCombinacoes;

        // Exibir resultados atualizados
        exibirResultados(ocorrencias, topDezenas, combinacoes, concursos);
      } else {
        alert('Nenhuma melhoria possível sem exceder o número de acertos desejado.');
      }
    }

    function calcularDesempenho(combinacoes, acertosDesejado) {
      // Calcula um valor de desempenho baseado nas combinações
      // Priorizando o número de acertos desejado e penalizando acertos acima

      let desempenho = 0;

      // Considera apenas acertos até o desejado
      for (let i = acertosDesejado; i >= 0; i--) {
        let key = `${i} acertos`;
        if (combinacoes[key]) {
          desempenho += combinacoes[key] * Math.pow(1000, i);
        }
      }

      // Penaliza acertos acima do desejado
      for (let i = acertosDesejado + 1; i <= 15; i++) {
        let key = `${i} acertos`;
        if (combinacoes[key]) {
          desempenho -= combinacoes[key] * Math.pow(1000, i);
        }
      }

      return desempenho;
    }
  </script>
</body>
</html>
